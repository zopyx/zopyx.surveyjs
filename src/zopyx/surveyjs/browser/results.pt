<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      metal:use-macro="context/main_template/macros/master"
>

<metal:block fill-slot="content-core">

    <link rel="stylesheet"
          type="text/css"
          href="++resource++zopyx.surveyjs/results.css"
    />

    <tal:block define="results view/get_paginated_results">

        <div id="results-table">

            <form method="get" action="">
                <input type="text" name="q" placeholder="Search by user..." tal:attributes="value request/q|string:''" />
                <button type="submit">Search</button>
            </form>

            <table class="table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>User</th>
                    <th>UUID</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr tal:repeat="item python:list(results['items'])">
                    <td tal:content="python: view.plone_api.portal.get_localized_time(item['created'], long_format=True)">Date</td>
                    <td tal:content="item/user">User</td>
                    <td tal:content="item/poll_id">UUID</td>
                    <td>
                        <button class="btn btn-primary view-json"
                                tal:attributes="data-poll-id item/poll_id">
                            View
                        </button>
                    </td>
                </tr>                </tbody>
            </table>

            <div class="pagination"
                 tal:define="pagination_info results;
                             query_string python:request.get('q') and '&q=' + request.get('q') or ''"
                 tal:condition="python: pagination_info['numpages'] > 1">
                <a tal:condition="python: pagination_info['page'] > 1"
                   tal:attributes="href python:'?b_start=' + str((pagination_info['page'] - 2) * pagination_info['pagesize']) + query_string"
                >&laquo; Previous</a>
                <span tal:repeat="i python:range(1, pagination_info['numpages'] + 1)">
          <a tal:condition="python: i != pagination_info['page']"
             tal:attributes="href python:'?b_start=' + str((i - 1) * pagination_info['pagesize']) + query_string"
             tal:content="i">
          </a>
          <span tal:condition="python: i == pagination_info['page']"
                tal:content="i" class="current-page"></span>
        </span>
                <a tal:condition="python: pagination_info['page'] < pagination_info['numpages']"
                   tal:attributes="href python:'?b_start=' + str(pagination_info['page'] * pagination_info['pagesize']) + query_string"
                >Next &raquo;</a>
            </div>
        </div>

        <!-- Modal for displaying JSON -->
        <div id="json-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <pre id="json-content"></pre>
            </div>
        </div>

    </tal:block>

    <ul id="downloadActions">
        <li>
            <a href="download-polls-json">Download data (JSON)</a>
        </li>
        <li>
            <a href="download-form-json">Download form (JSON)</a>
        </li>
    </ul>

    <script src="++resource++zopyx.surveyjs/results.js"
            type="text/javascript"
    ></script>

</metal:block>
</html>