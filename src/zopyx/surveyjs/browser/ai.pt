<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="zopyx.surveyjs">

<metal:block fill-slot="content-core">

  <!-- Inject JavaScript variables for AJAX -->
  <script type="text/javascript"
          tal:content="string: ACTUAL_URL='${context/absolute_url}'"
  ></script>
  <script type="text/javascript"
          tal:content="string: CSRF_TOKEN='${context/@@authenticator/token}'"
  ></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Load SurveyJS libraries for preview -->
  <link href="https://unpkg.com/survey-core/survey-core.min.css"
        rel="stylesheet"
        type="text/css"
  />
  <script src="https://unpkg.com/survey-core/survey.core.min.js"
          type="text/javascript"
  ></script>
  <script src="https://unpkg.com/survey-js-ui/survey-js-ui.min.js"
          type="text/javascript"
  ></script>
  <script src="https://unpkg.com/survey-core/themes/index.min.js"
          type="text/javascript"
  ></script>

  <!-- Load local CSS and JS -->
  <link rel="stylesheet"
        type="text/css"
        href="++resource++zopyx.surveyjs/ai.css"
  />
  <script src="++resource++zopyx.surveyjs/ai.js"
          type="text/javascript"
  ></script>

  <div class="ai-generator-container">

    <!-- Header -->
    <div class="ai-generator-header">
      <h2 i18n:translate="">AI Form Generator</h2>
      <div class="subtitle" i18n:translate="">
        Describe your survey in natural language and let AI generate the form
      </div>
    </div>

    <!-- Refinement Mode Container (always visible) -->
    <div class="refinement-mode-container">

      <!-- Left: History Timeline -->
      <div class="panel history-panel">
        <div class="panel-heading">
          <h3 class="panel-title">
            <span i18n:translate="">Refinement History</span>
          </h3>
        </div>
        <div class="panel-body">
          <div id="historyTimeline" class="history-timeline"></div>
        </div>
      </div>

      <!-- Right: Form Input and Actions -->
      <div class="panel refinement-panel">
        <div class="panel-heading">
          <h3 class="panel-title">
            <span id="formPanelTitle" i18n:translate="">Describe Your Form</span>
          </h3>
        </div>
        <div class="panel-body">
          <div class="current-state-indicator" id="versionIndicator" style="display:none;">
            <strong i18n:translate="">Current Version:</strong> <span id="currentVersionInfo"></span>
          </div>
          <form id="refinementForm">
            <div class="form-group">
              <label for="refinementInput" id="formInputLabel" i18n:translate="">
                Describe the form you want to create:
              </label>
              <textarea
                id="refinementInput"
                name="refinement"
                class="form-control"
                rows="6"
                placeholder="Example: Create a customer satisfaction survey with questions about product quality, delivery experience, and overall satisfaction. Include rating scales and a comments section."
                required
              ></textarea>
              <p class="help-block" id="formInputHelp" i18n:translate="">
                Be specific about the types of questions, response formats, and any particular fields you need.
              </p>
            </div>

            <div class="button-group">
              <button type="submit" class="btn btn-primary" id="refineBtn">
                <span class="btn-text" id="refineBtnText" i18n:translate="">Generate Form</span>
                <span class="btn-spinner" style="display:none;">
                  <span class="spinner"></span> <span id="refineBtnSpinnerText" i18n:translate="">Generating...</span>
                </span>
              </button>
              <button type="button" class="btn btn-secondary" id="startOverBtn" style="display:none;">
                <span i18n:translate="">Start Over</span>
              </button>
            </div>
          </form>

          <!-- Action Buttons (shown after form is generated) -->
          <div class="action-buttons" id="formActionButtons" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <button type="button" class="btn btn-info" id="previewJsonBtn">
              <span i18n:translate="">Preview JSON</span>
            </button>
            <button type="button" class="btn btn-info" id="previewFormBtn">
              <span i18n:translate="">Preview Form</span>
            </button>
            <button type="button" class="btn btn-success" id="saveBtn">
              <span i18n:translate="">Save Form</span>
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- Error Display (hidden initially) -->
    <div id="errorContainer" class="alert alert-danger" style="display:none;">
      <strong>Error:</strong> <span id="errorMessage"></span>
    </div>

  </div>

  <!-- Form Preview Modal -->
  <div id="previewFormModal" class="modal" style="display:none;">
    <div class="modal-content modal-content-large">
      <span class="close-button close-form-preview">&times;</span>
      <h2 i18n:translate="">Form Preview</h2>
      <div id="surveyContainer"></div>
    </div>
  </div>

  <!-- JSON Preview Modal -->
  <div id="previewJsonModal" class="modal" style="display:none;">
    <div class="modal-content modal-content-large">
      <span class="close-button close-json-preview">&times;</span>
      <h2 i18n:translate="">Form JSON</h2>
      <div class="json-modal-body">
        <pre id="jsonModalDisplay"></pre>
      </div>
    </div>
  </div>

</metal:block>
</html>
